<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ã˜ã¶ã‚“è¨ºæ–­</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#f7f5f2;
      --card:#ffffff;
      --text:#2f2e2d;
      --muted:#6b6b6b;
      --line:#e9e4df;
      --accent:#b8aaa2;
      --accent2:#6b7a8f;
      --ok:#2f7d5d;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      padding:24px;
      font-family:"Noto Sans JP", system-ui, -apple-system, sans-serif;
      background:var(--bg);
      color:var(--text);
      line-height:1.75;
    }
    .container{
      max-width: 920px;
      margin: 0 auto;
      background: var(--card);
      border-radius: 16px;
      border: 1px solid var(--line);
      box-shadow: 0 10px 28px rgba(0,0,0,.08);
      padding: 22px;
    }

    /* =====================
       ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢
    ===================== */
    #startScreen{
      display: block;
      text-align: center;
      padding: 10px 0 20px;
    }
    #startScreen h1{
      margin: 0 0 6px;
      font-size: 2rem;
      letter-spacing: .04em;
      color: var(--text);
    }
    .start-tagline{
      margin: 0 0 20px;
      color: var(--muted);
      font-size: 1rem;
    }
    .start-hero{
      width: 92%;
      max-width: 340px;
      display: block;
      margin: 0 auto 24px;
      border-radius: 16px;
      border: 1px solid var(--line);
      background: #fafafa;
    }
    .start-cards{
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
      margin: 0 0 24px;
      text-align: left;
    }
    .start-card{
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 14px 16px;
      background: #faf9f8;
    }
    .start-card-icon{
      font-size: 1.4rem;
      margin-bottom: 6px;
    }
    .start-card-label{
      font-size: .82rem;
      color: var(--muted);
      margin: 0 0 2px;
    }
    .start-card-value{
      font-size: .98rem;
      font-weight: 700;
      margin: 0;
      color: var(--text);
    }
    .start-notice{
      margin: 0 0 24px;
      padding: 14px 18px;
      background: #f2f7f4;
      border: 1px solid #c8dfd3;
      border-radius: 14px;
      text-align: left;
    }
    .start-notice p{
      margin: 0 0 6px;
      font-size: .97rem;
      color: #2f5a45;
    }
    .start-notice p:last-child{ margin: 0; }
    .start-notice strong{ font-weight: 700; }
    .start-btn{
      display: inline-block;
      padding: 16px 60px;
      background: linear-gradient(135deg, var(--accent2), var(--accent));
      color: #fff;
      font-size: 1.1rem;
      font-weight: 700;
      border: none;
      border-radius: 999px;
      cursor: pointer;
      box-shadow: 0 6px 18px rgba(107,122,143,.35);
      transition: transform .1s, box-shadow .1s;
      letter-spacing: .05em;
    }
    .start-btn:hover{
      transform: translateY(-2px);
      box-shadow: 0 10px 24px rgba(107,122,143,.4);
    }
    .start-btn:active{ transform: translateY(0); }

    /* =====================
       ã‚¯ã‚¤ã‚ºç”»é¢ï¼ˆå…±é€šãƒ˜ãƒƒãƒ€ãƒ¼ï¼‰
    ===================== */
    #quizScreen{ display: none; }
    #resultScreen{ display: none; }

    header.quiz-header{
      text-align:center;
      padding: 4px 0 14px;
    }
    header.quiz-header h1{
      margin:0 0 6px;
      font-size: 1.6rem;
      letter-spacing: .02em;
    }
    .subtitle{
      margin:0;
      color: var(--muted);
      font-size: .95rem;
    }
    .pill{
      display:inline-block;
      margin-top: 10px;
      padding: 6px 10px;
      border: 1px solid var(--line);
      border-radius: 999px;
      background:#faf9f8;
      color:#4a4846;
      font-size:.85rem;
    }
    .grid{
      display:grid;
      gap:14px;
      grid-template-columns: 1fr;
      margin-top: 14px;
    }
    .card{
      border:1px solid var(--line);
      border-radius: 16px;
      padding: 16px;
      background:#fff;
    }
    .progress{
      height: 10px;
      background:#efeae6;
      border-radius: 999px;
      overflow:hidden;
      border:1px solid var(--line);
    }
    .progress > div{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, var(--accent2), var(--accent));
      transition: width .2s ease;
    }
    .row{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content: space-between;
      flex-wrap:wrap;
      margin-top: 10px;
      color: var(--muted);
      font-size: .92rem;
    }
    .qwrap{
      display:grid;
      gap:12px;
      margin-top: 12px;
    }
    .q{
      border:1px solid var(--line);
      border-radius: 14px;
      padding: 12px;
      background:#fbfbfb;
    }
    .qhead{
      display:flex;
      gap:10px;
      align-items:flex-start;
      margin-bottom: 10px;
    }
    .qno{
      min-width: 46px;
      height: 28px;
      padding: 0 10px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      border-radius: 999px;
      background:#f2efec;
      border:1px solid var(--line);
      font-weight:700;
      font-size:.9rem;
      color:#4a4846;
    }
    .qtext{ margin:0; font-size: 1rem; }
    .choices{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .choice{
      flex:1;
      min-width: 180px;
      display:flex;
      gap:10px;
      align-items:center;
      padding: 10px 12px;
      border:1px solid var(--line);
      border-radius: 12px;
      background:#fff;
      cursor:pointer;
      transition: transform .08s, border-color .12s;
      user-select:none;
    }
    .choice:hover{
      transform: translateY(-1px);
      border-color:#d9d1cc;
    }
    .choice input{ transform: scale(1.12); }
    .btnrow{
      display:flex;
      gap:10px;
      margin-top: 12px;
    }
    button{
      flex:1;
      padding: 12px 14px;
      border-radius: 12px;
      border:none;
      cursor:pointer;
      font-weight:700;
      font-size: 1rem;
      background: var(--accent);
      color:#fff;
      transition: transform .08s, filter .15s;
    }
    button:hover{ transform: translateY(-1px); filter: brightness(.98); }
    button.secondary{
      background:#fff;
      color: var(--accent);
      border: 2px solid var(--accent);
    }
    button.ghost{
      background:#f7f5f2;
      color:#4a4846;
      border:1px solid var(--line);
    }
    button:disabled{
      opacity:.45;
      cursor:not-allowed;
      transform:none;
    }
    .note{
      margin: 10px 0 0;
      color: var(--muted);
      font-size: .9rem;
    }

    /* =====================
       çµæœç”»é¢
    ===================== */
    .resultTop{
      text-align:center;
      padding: 4px 0 2px;
    }
    .resultTop h2{
      margin:0 0 6px;
      font-size: 1.25rem;
    }
    .topCards{
      display:grid;
      gap:12px;
      grid-template-columns: repeat( auto-fit, minmax(220px, 1fr) );
      margin-top: 12px;
    }
    .topCard{
      border:1px solid var(--line);
      border-radius: 16px;
      padding: 14px;
      background:#fff;
      text-align:center;
    }
    .topImg{
      width: 100%;
      max-width: 240px;
      height: 180px;
      object-fit: contain;
      display:block;
      margin: 6px auto 10px;
      border-radius: 14px;
      border:1px solid var(--line);
      background:#faf9f8;
    }
    .topName{
      font-weight:800;
      font-size: 1.1rem;
      margin: 0;
    }
    .topScore{
      margin: 6px 0 0;
      color: var(--muted);
      font-size: .95rem;
    }
    .scoreTable{
      width:100%;
      border-collapse: collapse;
      margin-top: 14px;
      background:#fff;
      border-radius: 14px;
      overflow:hidden;
      border:1px solid var(--line);
    }
    .scoreTable th, .scoreTable td{
      padding: 10px 12px;
      border-bottom:1px solid var(--line);
      text-align:left;
      font-size: .95rem;
      vertical-align: middle;
    }
    .scoreTable th{ background:#faf9f8; }
    .typeCell{
      display:flex;
      gap:10px;
      align-items:center;
    }
    .typeIcon{
      width: 38px;
      height: 38px;
      object-fit: contain;
      border-radius: 10px;
      border:1px solid var(--line);
      background:#fff;
      flex: 0 0 auto;
    }
    .bar{
      height: 10px;
      border-radius: 999px;
      background: #efeae6;
      overflow:hidden;
      border:1px solid var(--line);
    }
    .bar > div{
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, var(--ok), var(--accent2));
    }

    /* =====================
       ã‚·ã‚§ã‚¢ãƒœãƒƒã‚¯ã‚¹
    ===================== */
    .shareBox{
      margin-top: 16px;
      padding: 14px;
      border: 1px solid var(--line);
      border-radius: 16px;
      background: #faf9f8;
    }
    .shareTitle{
      margin: 0 0 6px;
      font-size: 1.05rem;
    }
    .shareHelp{
      margin: 0 0 10px;
      color: var(--muted);
      font-size: .92rem;
    }
    .shareText{
      width: 100%;
      resize: vertical;
      border-radius: 12px;
      border: 1px solid var(--line);
      padding: 12px;
      font-family: inherit;
      line-height: 1.6;
      background: #fff;
    }
    .shareButtons{
      display: grid;
      grid-template-columns: repeat(4, minmax(0,1fr));
      gap: 10px;
      margin-top: 10px;
    }
    .shareBtn{
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 12px 10px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: #fff;
      color: #333;
      font-weight: 700;
      text-decoration: none;
      cursor: pointer;
      font-size: .95rem;
    }
    .shareBtn.primary{
      background: var(--accent2);
      color: #fff;
      border: none;
    }

    @media (max-width: 640px){
      body{ padding: 14px; }
      #startScreen h1{ font-size: 1.6rem; }
      .start-btn{ padding: 14px 40px; font-size: 1rem; }
      .choice{ min-width: 140px; }
      .btnrow{ flex-direction: column; }
      .shareButtons{ grid-template-columns: 1fr 1fr; }
      .topImg{ height: 160px; }
    }
  </style>
</head>

<body>
<div class="container">

  <!-- =====================
       ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢
  ===================== -->
  <div id="startScreen">
    <h1>ã˜ã¶ã‚“è¨ºæ–­</h1>
    <p class="start-tagline">ã‚ãªãŸã®ã€Œæœ¬æ¥ã®å‚¾å‘ã€ã‚’è¦‹ã¤ã‘ã‚‹9ã‚¿ã‚¤ãƒ—è¨ºæ–­</p>

    <img class="start-hero"
         src="main.png"
         alt="ã˜ã¶ã‚“è¨ºæ–­"
         onerror="this.style.display='none'">

    <!-- è¨ºæ–­æ¦‚è¦ã‚«ãƒ¼ãƒ‰ -->
    <div class="start-cards">
      <div class="start-card">
        <div class="start-card-icon">ğŸ•</div>
        <p class="start-card-label">æ‰€è¦æ™‚é–“ã®ç›®å®‰</p>
        <p class="start-card-value">ç´„5ã€œ10åˆ†</p>
      </div>
      <div class="start-card">
        <div class="start-card-icon">ğŸ“</div>
        <p class="start-card-label">è¨­å•æ•°</p>
        <p class="start-card-value">å…¨63å•ãƒ»7ãƒšãƒ¼ã‚¸</p>
      </div>
      <div class="start-card">
        <div class="start-card-icon">â­•</div>
        <p class="start-card-label">å›ç­”æ–¹æ³•</p>
        <p class="start-card-value">ã€‡ / â–³ / Ã— ã®3æŠ</p>
      </div>
      <div class="start-card">
        <div class="start-card-icon">ğŸ¯</div>
        <p class="start-card-label">è¨ºæ–­çµæœ</p>
        <p class="start-card-value">9ã‚¿ã‚¤ãƒ—ã‹ã‚‰å‚¾å‘ã‚’è¡¨ç¤º</p>
      </div>
    </div>

    <!-- æ³¨æ„æ›¸ã -->
    <div class="start-notice">
      <p>ğŸ’¡ <strong>æ­£è§£ãƒ»ä¸æ­£è§£ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</strong></p>
      <p>ä»Šã®è‡ªåˆ†ã®æ°—æŒã¡ã§ã€ç‡ç›´ã«ç­”ãˆã¦ãã ã•ã„ã€‚</p>
      <p>æ·±ãè€ƒãˆã™ããšã€ãƒ‘ãƒƒã¨æ€ã£ãŸã“ã¨ã‚’å¤§åˆ‡ã«ã€‚</p>
      <p style="margin-top:10px;">ğŸ“Š è¨ºæ–­çµæœã¯9ã¤ã®ã‚¿ã‚¤ãƒ—ã®ã†ã¡ã€<strong>ã‚ãªãŸã®å‚¾å‘ãŒå¼·ã„ã‚‚ã®ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚</strong></p>
    </div>

    <button class="start-btn" onclick="startQuiz()">è¨ºæ–­ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
  </div>

  <!-- =====================
       ã‚¯ã‚¤ã‚ºç”»é¢
  ===================== -->
  <div id="quizScreen">
    <header class="quiz-header">
      <h1>ã˜ã¶ã‚“è¨ºæ–­</h1>
      <p class="subtitle">ã€‡ / â–³ / Ã—ã§ç­”ãˆã‚‹ï¼ˆå„ã‚¿ã‚¤ãƒ—ã‹ã‚‰7å•ãšã¤ãƒ©ãƒ³ãƒ€ãƒ å‡ºé¡Œï¼‰</p>
      <span class="pill">é…ç‚¹ï¼šã€‡=1ç‚¹ / â–³=0.5ç‚¹ / Ã—=0ç‚¹ï¼ˆå„ã‚¿ã‚¤ãƒ—æº€ç‚¹7ç‚¹ï¼‰</span>
    </header>

    <div class="grid">
      <section class="card" id="quizCard">
        <div class="progress" aria-label="é€²æ—">
          <div id="progressFill"></div>
        </div>

        <div class="row">
          <div id="pageInfo">1 / 7 ãƒšãƒ¼ã‚¸ï¼ˆå…¨63å•ï¼‰</div>
          <div id="answeredInfo">ã“ã®ãƒšãƒ¼ã‚¸ï¼š0 / 9 å›ç­”</div>
        </div>

        <form id="quizForm">
          <div id="questionArea" class="qwrap"></div>

          <div class="btnrow">
            <button type="button" class="secondary" id="prevBtn">æˆ»ã‚‹</button>
            <button type="button" id="nextBtn">æ¬¡ã¸</button>
            <button type="submit" id="submitBtn" style="display:none;">çµæœã‚’è¦‹ã‚‹</button>
          </div>

          <p class="note">
            â€»ãƒšãƒ¼ã‚¸å†…ã¯å…¨å•å›ç­”ãŒå¿…è¦ã§ã™ï¼ˆæˆ»ã‚‹ã¯æœªå›ç­”ã§ã‚‚OKï¼‰<br>
            â€»åŒç‚¹ã®å ´åˆã¯ãƒˆãƒƒãƒ—ã‚’ã™ã¹ã¦è¡¨ç¤ºã—ã¾ã™ã€‚
          </p>
        </form>
      </section>
    </div>
  </div>

  <!-- =====================
       çµæœç”»é¢
  ===================== -->
  <div id="resultScreen">
    <header class="quiz-header">
      <h1>ã˜ã¶ã‚“è¨ºæ–­</h1>
    </header>

    <div class="grid">
      <section class="card">
        <div class="resultTop">
          <h2>è¨ºæ–­çµæœ</h2>
          <p class="subtitle" id="topSummary"></p>
        </div>

        <div class="topCards" id="topCards"></div>

        <table class="scoreTable" id="scoreTable">
          <thead>
            <tr>
              <th style="width:220px;">ã‚¿ã‚¤ãƒ—</th>
              <th style="width:160px;">ã‚¹ã‚³ã‚¢ï¼ˆ/7ï¼‰</th>
              <th>å‰²åˆ</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>

        <!-- ã‚·ã‚§ã‚¢ç”¨ãƒ†ã‚­ã‚¹ãƒˆ -->
        <div class="shareBox" id="shareBox">
          <h3 class="shareTitle">ã‚·ã‚§ã‚¢ç”¨ãƒ†ã‚­ã‚¹ãƒˆ</h3>
          <p class="shareHelp">è‡ªå‹•ç”Ÿæˆã•ã‚ŒãŸæ–‡ç« ã‚’ãã®ã¾ã¾æŠ•ç¨¿ã§ãã¾ã™ï¼ˆå¿…è¦ãªã‚‰ç·¨é›†OKï¼‰</p>

          <textarea id="shareText" class="shareText" rows="7"></textarea>

          <div class="shareButtons">
            <button type="button" class="shareBtn primary" id="copyShareBtn">ã‚³ãƒ”ãƒ¼</button>
            <button type="button" class="shareBtn" id="nativeShareBtn">å…±æœ‰ã™ã‚‹</button>
            <a class="shareBtn" id="xShareLink" target="_blank" rel="noopener">Xã§ã‚·ã‚§ã‚¢</a>
            <a class="shareBtn" id="lineShareLink" target="_blank" rel="noopener">LINEã§é€ã‚‹</a>
          </div>
        </div>

        <div class="btnrow" style="margin-top:14px;">
          <button type="button" class="ghost" id="retryBtn">ã‚‚ã†ä¸€åº¦ï¼ˆå†æŠ½å‡ºãƒ»å†ã‚·ãƒ£ãƒƒãƒ•ãƒ«ï¼‰</button>
        </div>

        <p class="note" style="text-align:center;">
          â€»ã“ã‚Œã¯ç°¡æ˜“è¨ºæ–­ã§ã™ã€‚ã‚ãã¾ã§ã€Œå‚¾å‘ã€ã¨ã—ã¦ã”æ´»ç”¨ãã ã•ã„ã€‚
        </p>
      </section>
    </div>
  </div>

</div><!-- /.container -->

<script>
  /***********************
   * è¨­å®šï¼šGAS Webã‚¢ãƒ—ãƒªURL
   ***********************/
  const GAS_WEBAPP_URL = "ã“ã“ã«GASã®Webã‚¢ãƒ—ãƒªURLã‚’è²¼ã‚‹";

  /***********************
   * ã‚¿ã‚¤ãƒ—å®šç¾©
   ***********************/
  const TYPES = [
    { id:"silver",    name:"ã‚·ãƒ«ãƒãƒ¼ã‚¿ã‚¤ãƒ—",   img:"silver.png" },
    { id:"pink",      name:"ãƒ”ãƒ³ã‚¯ã‚¿ã‚¤ãƒ—",     img:"pink.png" },
    { id:"gold",      name:"ã‚´ãƒ¼ãƒ«ãƒ‰ã‚¿ã‚¤ãƒ—",   img:"gold.png" },
    { id:"purple",    name:"ãƒ‘ãƒ¼ãƒ—ãƒ«ã‚¿ã‚¤ãƒ—",   img:"purple.png" },
    { id:"navy",      name:"ãƒã‚¤ãƒ“ãƒ¼ã‚¿ã‚¤ãƒ—",   img:"navy.png" },
    { id:"green",     name:"ã‚°ãƒªãƒ¼ãƒ³ã‚¿ã‚¤ãƒ—",   img:"green.png" },
    { id:"yellow",    name:"ã‚¤ã‚¨ãƒ­ãƒ¼ã‚¿ã‚¤ãƒ—",   img:"yellow.png" },
    { id:"red",       name:"ãƒ¬ãƒƒãƒ‰ã‚¿ã‚¤ãƒ—",     img:"red.png" },
    { id:"turquoise", name:"ã‚¿ãƒ¼ã‚³ã‚¤ã‚ºã‚¿ã‚¤ãƒ—", img:"turquoise.png" }
  ];

  /***********************
   * è¨­å•ï¼ˆå„10å•ï¼‰
   ***********************/
  const QUESTIONS_BY_TYPE = {
    silver: [
      "ã¡ã‚ƒã‚“ã¨ã‚„ã‚ŠãŸãã¦è¡Œå‹•ã—ãŸã®ã«ã€ã¾ã˜ã‚ã™ãã‚‹ã¨è¨€ã‚ã‚Œã‚‹ã“ã¨ãŒã‚ã‚‹",
      "ä¼‘ã‚“ã ã‚ŠéŠã‚“ã ã‚Šã™ã‚‹ã¨ã€ã“ã‚Œã§ã„ã„ã®ã‹ãªï¼Ÿã¨æ€ã£ã¦ã—ã¾ã†",
      "ã‚„ã‚‹ã¹ãã“ã¨ã‚’ã—ã£ã‹ã‚Šã‚„ã‚‹ã¨ã€è‡ªåˆ†ã«è‡ªä¿¡ãŒæŒã¦ã‚‹",
      "é…åˆ»ã¯è¨±ã›ãªã„ã—ã€ç´„æŸã¯å¿…ãšå®ˆã£ã¦ã»ã—ã„",
      "æ„Ÿæƒ…ã‚’ä¼ãˆã‚‹ã‚ˆã‚Šã‚‚æ­£ã—ãä¼ãˆã‚‹ã“ã¨ã‚’å„ªå…ˆã™ã‚‹ã“ã¨ãŒå¤šã„",
      "ãƒ«ãƒ¼ãƒ«ã‚„æ±ºã¾ã‚Šã”ã¨ãŒã¡ã‚ƒã‚“ã¨å®ˆã‚‰ã‚Œã¦ã„ã‚‹ã¨ã€ã‚„ã‚‹æ°—ãŒå‡ºã‚‹",
      "è‡ªåˆ†ãŒã—ã£ã‹ã‚Šã—ãªã„ã¨ã€å‘¨ã‚ŠãŒå›°ã‚‹æ°—ãŒã—ã¦ã—ã¾ã†",
      "ãƒŸã‚¹ãŒã‚ã‚‹ã“ã¨ãŒè¨±ã›ãªã„ã‹ã‚‰ã€ç´°ã‹ã„ã¨ã“ã‚ã¾ã§ç¢ºèªã™ã‚‹",
      "æ­£ã—ã„ã“ã¨ã€é–“é•ã£ã¦ã„ã‚‹ã“ã¨ã‚’ã€ã¯ã£ãã‚Šã•ã›ãŸããªã‚‹",
      "ãƒ€ãƒ¡ãªã‚‚ã®ã¯ãƒ€ãƒ¡ã ã¨ã€ã¯ã£ãã‚Šä¼ãˆãŸããªã‚‹ã“ã¨ãŒã‚ã‚‹"
    ],
    pink: [
      "èª°ã‹ãŒå›°ã£ã¦ã„ã‚‹ã¨ã€ã»ã£ã¨ã‘ãªãã¦ã€ã™ãã«æ‰‹ã‚’å‡ºã—ã¦ã—ã¾ã†",
      "ã©ã‚“ãªäººã¨ã§ã‚‚å’Œæ°—ã‚ã„ã‚ã„ã¨è©±ãŒã§ãã€æ¥½ã—ã„ã¨æ„Ÿã˜ã‚‹",
      "èª°ã‹ã‚’åŠ©ã‘ãŸã¨ãã€ç›¸æ‰‹ãŒç¬‘é¡”ã«ãªã‚‹ã¨ã€ãã‚Œã ã‘ã§å¬‰ã—ã„",
      "èº«è¿‘ãªäººã‚’æ¥½ã—ã¾ã›ã€ã‚‚ã¦ãªã™ã“ã¨ãŒå¤§å¥½ãã ",
      "è‡ªåˆ†ãŒã—ã¦ã‚ã’ãŸã“ã¨ã«æ„Ÿè¬ã•ã‚Œãªã„ã¨å«Œãªæ°—æŒã¡ã«ãªã‚‹",
      "ç›¸æ‰‹ã®ã„ã„ã¨ã“ã‚ã‚’è¦‹ã¤ã‘ã‚‹ã¨ã€ç´ ç›´ã«ä¼ãˆãŸããªã‚‹",
      "ãƒ—ãƒ¬ã‚¼ãƒ³ãƒˆã‚„ãŠã™ãåˆ†ã‘ã‚’ã™ã‚‹ã®ãŒå¥½ãã§ã€ã¤ã„ã€ã¿ã‚“ãªã«ã‚ã’ãŸããªã‚‹",
      "äººã®å½¹ã«ç«‹ã¤ãªã‚‰ã€è‡ªåˆ†ã®ã‚„ã‚‹ã¹ãã“ã¨ã‚’å¾Œå›ã—ã«ã—ã¦ã—ã¾ã†ã“ã¨ãŒã‚ˆãã‚ã‚‹",
      "äººã‹ã‚‰ãŠé¡˜ã„ã•ã‚Œã‚‹ã¨ã€ã‚„ã‚‹ã“ã¨ãŒã„ã£ã±ã„ãªæ™‚ã§ã‚‚ã€æ–­ã‚Œãªã„",
      "ä»²ã®è‰¯ã„äººãŒä»–ã®äººã¨ä»²è‰¯ãã—ã¦ã„ã‚‹ã¨ã€ã™ã”ããƒ¢ãƒ¤ãƒ¢ãƒ¤ã™ã‚‹"
    ],
    gold: [
      "è‡ªåˆ†ãŒã†ã¾ãã„ã£ã¦ã„ãªã„ã¨å‘¨ã‚Šã‹ã‚‰æ€ã‚ã‚Œã‚‹ã®ãŒã‚¤ãƒ¤ã ",
      "è¦‹ãŸç›®ã‚„è©±ã—æ–¹ãŒã‚­ãƒã‚‹ã¨ã€æ°—åˆ†ãŒä¸ŠãŒã‚‹",
      "ã¾ã‚ã‚Šã‹ã‚‰æœŸå¾…ã•ã‚Œãªã„ã¨ã‚„ã‚‹æ°—ãŒå‡ºãªã„",
      "é ‘å¼µã£ãŸã“ã¨ã¯ã€ã¡ã‚ƒã‚“ã¨è¦‹ã¦ã‚‚ã‚‰ã„ãŸã„ã¨æ€ã†",
      "å‘¨ã‚Šã®äººãŒæˆåŠŸã™ã‚‹ã¨å¿ƒãŒã–ã‚ã–ã‚ã™ã‚‹",
      "ã©ã†ã›ã‚„ã‚‹ãªã‚‰ä¸€ç•ªã‚’å–ã‚ŠãŸã„ãŒé ‘å¼µã£ã¦ã„ã‚‹å§¿ã¯è¦‹ã‚‰ã‚ŒãŸããªã„",
      "è‡ªä¿¡ãŒãªã„éƒ¨åˆ†ã‚’äººã«è¦‹ã›ãŸããªã„",
      "åŠ¹ç‡è‰¯ãè¡Œå‹•ã—ãŸã„ã€ãƒ ãƒ€ãªã“ã¨ã‚’ã—ãŸããªã„",
      "ã‚‚ã£ã¨åŠªåŠ›ã™ã‚Œã°ã€ã‚‚ã£ã¨æˆé•·ã§ãã‚‹ã®ã«ï¼ã£ã¦ã‚ˆãæ€ã†",
      "ã†ã¾ãã„ã£ãŸã®ã«å‘¨ã‚Šã‹ã‚‰èªã‚ã¦ã‚‚ã‚‰ãˆãªã„ã¨ã€ã¨ã¦ã‚‚ã‚¬ãƒƒã‚«ãƒªã™ã‚‹"
    ],
    purple: [
      "ã‚ˆãã€Œå€‹æ€§çš„ã€ã¨è¨€ã‚ã‚Œã‚‹ã“ã¨ãŒã‚ã‚Šã€ãã‚ŒãŒå¬‰ã—ã„",
      "æ™®é€šã®äººç”Ÿã‚ˆã‚Šã‚‚ã€è‡ªåˆ†ã ã‘ã®ç‰¹åˆ¥ãªäººç”Ÿã«ã—ãŸã„",
      "ãƒªãƒ¼ãƒ‰ã—ãŸããªã„ã—ã€æŒ‡ç¤ºã•ã‚ŒãŸããªã„",
      "è‡ªåˆ†ãŒå¥½ãã ã¨æ€ãˆã‚‹ã“ã¨ã˜ã‚ƒãªã„ã¨ã€ã‚„ã‚‹æ°—ãŒå‡ºãªã„",
      "ãƒ«ãƒ¼ãƒ«ã‚„ä¸€èˆ¬çš„å¸¸è­˜ã‚ˆã‚Šã‚‚ã€è‡ªåˆ†ã‚‰ã—ã•ã‚’å¤§åˆ‡ã«ã—ãŸã„",
      "å‹˜ãŒé‹­ã„ã»ã†ã ",
      "å¦„æƒ³ã™ã‚‹ã®ãŒå¥½ã",
      "ä½œã‚ŠãŸã„ã¨æ€ã£ãŸã‚‚ã®ã‚’ä¸€äººã§ã‚‚ãã‚‚ãã¨ä½œã‚‹ã®ãŒå¥½ã",
      "ã‚»ãƒ³ã‚¹ã‚„ãƒ•ã‚¡ãƒƒã‚·ãƒ§ãƒ³ã«è‡ªåˆ†ãªã‚Šã®ã“ã ã‚ã‚ŠãŒã‚ã‚‹",
      "æœ¬å½“ã¯ã“ã†æ€ã£ã¦ã‚‹ã‚“ã§ã—ã‚‡ï¼Ÿã¨æ±ºã‚ã¤ã‘ã‚‰ã‚Œã¦è¨€ã‚ã‚Œã‚‹ã®ãŒã‚¤ãƒ¤ã "
    ],
    navy: [
      "ã²ã¨ã‚Šã§ã„ã‚‹æ–¹ãŒæ°—æ¥½ã§ã„ã„",
      "ç›®ç«‹ã¤ã¨ã‚ã‚Œã“ã‚Œèã‹ã‚Œã‚‹ã®ãŒã—ã‚“ã©ã„ã‹ã‚‰ã€é™ã‹ã«ã—ã¦ã„ã‚‹",
      "å‘¨ã‚Šã®è¦ªåˆ‡ã‚’ç´ ç›´ã«å—ã‘å–ã‚Œãšå‹˜ãã£ã¦ã—ã¾ã†ã“ã¨ãŒã‚ã‚‹",
      "è‡ªåˆ†ã®è¤‡é›‘ãªæ°—æŒã¡ã‚’ç†è§£ã§ãã‚‹äººã¯å°‘ãªã„ã—ã€ç†è§£ã—ã¦ã»ã—ã„ã¨ã‚‚æ€ã‚ãªã„",
      "æ°—ã«ãªã£ãŸã“ã¨ã‚’ã¨ã“ã¨ã‚“èª¿ã¹ã‚‹ã®ãŒã™ã”ãæ¥½ã—ã„",
      "éŠã³ã«è¡Œãç›´å‰ã«ãªã‚‹ã¨ã€è¡ŒããŸããªããªã‚‹",
      "ã‚‚ã‚ã”ã¨ã«ã¯é–¢ã‚ã‚ŠãŸããªã„ã—ã€é–¢ã‚ã‚‰ãªã„",
      "é›†ä¸­ã—ãŸã‚‰å‘¨ã‚ŠãŒã¾ã£ãŸãæ°—ã«ãªã‚‰ãªã„",
      "ã™ã‚Œé•ã†äººã®äººé–“è¦³å¯Ÿã‚’ã—ã¦æ¥½ã—ã‚“ã§ã„ã‚‹",
      "è‡ªåˆ†ã®èˆˆå‘³ã®ã‚ã‚‹ã“ã¨ä»¥å¤–ã€ã»ã¨ã‚“ã©æ„è­˜ã«å…¥ã‚‰ãªã„"
    ],
    green: [
      "ã€Œã“ã®äººãªã‚‰å¤§ä¸ˆå¤«ã€ã£ã¦æ€ãˆãŸã‚‰ã€ãªã‚“ã§ã‚‚ç´ ç›´ã«è©±ã›ã‚‹ã‚ˆã†ã«ãªã‚‹",
      "ãƒªãƒ¼ãƒ€ãƒ¼çš„ãªç«‹ã¡ä½ç½®ã‚ˆã‚Šã‚‚ä»²é–“ã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ã“ã¨ãŒå¤šã„",
      "æ…é‡ã«ãªã‚Šã™ãã¦ã€ãªã‹ãªã‹è¸ã¿å‡ºã›ãªã„ã“ã¨ãŒã‚ã‚‹",
      "äººã‹ã‚‰æŒ‡ç¤ºã•ã‚ŒãŸã“ã¨ã‚’ã™ã‚‹æ–¹ãŒè¡Œå‹•ã—ã‚„ã™ã„",
      "è‡ªåˆ†ã‹ã‚‰å£°ã‚’ã‹ã‘ã‚‹ã®ã¯å‹‡æ°—ãŒã„ã‚‹ãŒã€ä¸€äººã§ã„ã‚‹ã‚ˆã‚Šé›†å›£ã§è¡Œå‹•ã™ã‚‹æ–¹ãŒå¥½ã",
      "ã€Œã“ã‚Œã‚’ã‚„ã£ãŸã‚‰æ€’ã‚‰ã‚Œã‚‹ã€ãŒã‚ã‹ã‚‹ã®ã§ã€ã‚„ã‚‰ãªã„ã‚ˆã†ã«ã—ã¦ã„ã‚‹",
      "æ±ºã¾ã£ãŸãƒ«ãƒ¼ãƒ«ã§ã‚‚ã€æœ¬å½“ã«æ­£ã—ã„ã®ã‹ã¨è€ƒãˆã¦ã—ã¾ã†",
      "ã‚³ãƒ„ã‚³ãƒ„ã€ãŸã‚“ãŸã‚“ã¨ä½œæ¥­ã™ã‚‹ã®ãŒå¥½ã",
      "ä»Šå¾Œã©ã†ãªã‚‹ã‹ã‚ã‹ã‚‰ãªã„çŠ¶æ³ã«ãªã‚‹ã¨ã€ç«‹ã¡æ­¢ã¾ã£ã¦ã‚ˆãèª¿ã¹ãŸã‚Šç›¸è«‡ã—ãŸã‚Šã™ã‚‹",
      "ã„ã¤ã‚‚ã¯æ…é‡ã ãŒã€ã‚„ã‚‹ã£ï¼ã¨æ±ºã‚ãŸã‚‰ã€ã‚„ã‚‰ãªã‹ã£ãŸã®ãŒã‚¦ã‚½ã®ã‚ˆã†ã«ã‚‚ã®ã™ã”ãã‚„ã‚‹ï¼"
    ],
    yellow: [
      "è½ã¡è¾¼ã‚“ã§ã‚‚ã€ã™ãã«ç«‹ã¡ç›´ã‚‹",
      "æ¥½ã—ã‹ã£ãŸã®ã«ã€æ€¥ã«é£½ãã‚‹",
      "ãŠé‡‘ãŒã‚ã‚‹ã¨ã€å¾Œå…ˆè€ƒãˆãšã«æ¬²ã—ã„ã‚‚ã®ã‚’è²·ã£ã¦ã—ã¾ã†",
      "ãŠã‚‚ã—ã‚ãã†ãªã‚‚ã®ã¯ã€ã™ãã«è©¦ã—ã¦ã¿ãŸããªã‚‹",
      "å¸¸ã«ä½•ã‹ã—ã¦ã„ãªã„ã¨è½ã¡ç€ã‹ãªã„",
      "ä½•ã‹ã‚’ã—ã¦ã„ã¦ã‚‚æ¥½ã—ã„ã“ã¨ãŒè¦‹ã¤ã‹ã‚‹ã¨ã€ã™ããã£ã¡ã«æ°—ãŒå‘ã",
      "ã„ã‚ã‚“ãªäººã«å‡ºé€¢ã†ã“ã¨ãŒå¥½ã",
      "ç´°ã‹ã„ã“ã¨ã¯è€ƒãˆãšã€ç›´æ„Ÿã§å‹•ã",
      "ã‚„ã‚ŠãŸã„ã“ã¨ãŒå¤šã™ãã¦ã€ã©ã‚Œã‹ã‚‰æ‰‹ã‚’ã¤ã‘ã‚‹ã‹è¿·ã†",
      "ã¿ã‚“ãªã¨æ¥½ã—ã„ã“ã¨ã‚’ã©ã‚“ã©ã‚“ã‚„ã‚ŠãŸã„"
    ],
    red: [
      "è‡ªåˆ†ã®æ„è¦‹ã‚’ã¯ã£ãã‚Šä¼ãˆã‚‹ã»ã†ã ",
      "æ°—ã¥ã„ãŸã‚‰ã€è‡ªåˆ†ãŒä¸­å¿ƒã«ãªã£ã¦ã„ã‚‹ã“ã¨ãŒå¤šã„",
      "æ–°ã—ã„ã“ã¨ã‚’ã™ã‚‹ã¨ãã«ã€ä»Šã¾ã§ã‚„ã£ã¦ããŸã“ã¨ã§ã‚‚ä¸è¦ã¨æ€ãˆã°ã‚¹ãƒ‘ãƒƒã¨æ‰‹æ”¾ã›ã‚‹",
      "è‡ªåˆ†ãŒæ­£ã—ã„ã¨æ€ã£ãŸã“ã¨ã¯è­²ã‚Œãªã„",
      "æ°—ã«ã‹ã‘ã¦ã„ãŸå¾Œè¼©ãŒã€æˆé•·ã—ã¦ã„ã‚‹ã¨å¬‰ã—ã„",
      "ãƒãƒƒã‚­ãƒªè¨€ã‚ãªã„äººã«ã¯ã‚¤ãƒ©ã‚¤ãƒ©ã™ã‚‹",
      "ã‚‚ã®ã™ã”ãæ€’ã£ã¦ã‚‚ã€å‰²ã¨ã™ãã«å¿˜ã‚Œã‚‹",
      "èª°ã‹ã«é ¼ã‚‹ã‚ˆã‚Šã€è‡ªåˆ†ã§ã‚„ã£ãŸæ–¹ãŒæ—©ã„ã¨æ€ã†",
      "å‹è² ã”ã¨ã«ãªã‚‹ã¨ã€ã¤ã„æœ¬æ°—ã«ãªã£ã¦ã—ã¾ã†",
      "ä»²é–“ã«ã¯ã¨ã¦ã‚‚å„ªã—ã„ãŒã€ä»²é–“ä»¥å¤–ã«ã¯ã‚­ãƒ“ã‚·ã‚¤"
    ],
    turquoise: [
      "ã²ã¨ã‚Šã§ã‚‚å¤šæ•°ã§ã‚‚ã€è½ã¡ç€ã‘ã‚‹ç©ºé–“ãªã‚‰ã©ã¡ã‚‰ã§ã‚‚ã‚ˆã„",
      "æ„Ÿæƒ…ã®æµ®ãæ²ˆã¿ã¯ã‚ã¾ã‚Šãªã„",
      "æ™®æ®µã‚ã¾ã‚Šæ€’ã‚‰ãªã„ãŒã€æ€’ã‚‹ã¨ãã¯å‘¨ã‚ŠãŒãƒ“ãƒƒã‚¯ãƒªã™ã‚‹ãã‚‰ã„æ€’ã‚‹",
      "ç©ºæ°—ã‚’èª­ã¿ã€ãã®å ´ã«åˆã‚ã›ãŸè¡Œå‹•ã™ã‚‹ã®ãŒå¾—æ„",
      "ã€Œå¿ƒåœ°ã‚ˆãã„ã‚‹ã“ã¨ã€ã¯ç§ã«ã¨ã£ã¦ã¨ã¦ã‚‚å¤§åˆ‡ãªã“ã¨ã ",
      "ä»Šã®çŠ¶æ…‹ã§å……åˆ†ã ã¨æ€ã£ã¦ã„ã‚‹",
      "ã‚‚ã‚ã”ã¨ã«ãªã‚Šãã†ãªã‚‰ã€è‡ªåˆ†ã®æ„è¦‹ã¯è¨€ã‚ãªã„",
      "ã‚ã¾ã‚Šç„¦ã£ãŸã‚Šã€æ…Œã¦ãŸã‚Šã—ãªã„ã­ã¨è¨€ã‚ã‚Œã‚‹ã“ã¨ãŒå¤šã„",
      "å«Œã„ãªäººã®è‰¯ã„ã¨ã“ã‚ãŒè¦‹ãˆã¡ã‚ƒã£ã¦ã€å«Œã„ã«ãªã‚Šãã‚Œãªã„",
      "ã²ãªãŸã¼ã£ã“ã‚„ãªã«ã‚‚ã›ãšã«ã¼ãƒ¼ã£ã¨ã—ã¦ã„ã‚‹æ™‚é–“ãŒå¥½ã"
    ]
  };

  /***********************
   * è¨­å®šå€¤
   ***********************/
  const PICK_PER_TYPE = 7;
  const QUESTIONS_PER_PAGE = 9;
  const SCORE_HALF = { maru:2, sankaku:1, batsu:0 };

  /***********************
   * ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
   ***********************/
  function shuffleInPlace(array){
    for(let i=array.length-1; i>0; i--){
      const j = Math.floor(Math.random()*(i+1));
      [array[i], array[j]] = [array[j], array[i]];
    }
  }
  function escapeHtml(str){
    return String(str)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }
  function sampleWithoutReplacement(arr, k){
    const copy = [...arr];
    shuffleInPlace(copy);
    return copy.slice(0, k);
  }
  function fmtHalfScore(half){
    const v = half / 2;
    return Number.isInteger(v) ? String(v) : v.toFixed(1);
  }

  function buildQuestionBank(){
    const bank = [];
    for(const t of TYPES){
      const all = QUESTIONS_BY_TYPE[t.id] || [];
      if(all.length < PICK_PER_TYPE){
        throw new Error(`${t.name} ã®è¨­å•ãŒ ${PICK_PER_TYPE}å• æœªæº€ã§ã™ï¼ˆç¾åœ¨ ${all.length}å•ï¼‰`);
      }
      const picked = sampleWithoutReplacement(all, PICK_PER_TYPE);
      picked.forEach(text => bank.push({ typeId: t.id, typeName: t.name, text }));
    }
    shuffleInPlace(bank);
    return bank;
  }

  /***********************
   * ç«¯æœ«ãƒ»ã‚¸ã‚ªæƒ…å ±
   ***********************/
  function detectDeviceBrowserOS(){
    const ua = navigator.userAgent || "";
    const lower = ua.toLowerCase();
    let device = "PC";
    if (/iphone|ipad|ipod/i.test(ua)) device = "iPhone/iPad";
    else if (/android/i.test(ua)) device = "Android";
    let os = "Unknown";
    if (/iphone|ipad|ipod/i.test(ua)) os = "iOS";
    else if (/android/i.test(ua)) os = "Android";
    else if (/windows nt/i.test(lower)) os = "Windows";
    else if (/mac os x/i.test(lower)) os = "macOS";
    let browser = "Unknown";
    if (/edg/i.test(ua)) browser = "Edge";
    else if (/chrome/i.test(ua) && !/edg|opr|opera/i.test(ua)) browser = "Chrome";
    else if (/safari/i.test(ua) && !/chrome/i.test(ua)) browser = "Safari";
    else if (/firefox/i.test(ua)) browser = "Firefox";
    return { device, browser, os };
  }

  function getTimeZone(){
    try{ return Intl.DateTimeFormat().resolvedOptions().timeZone || ""; }
    catch(e){ return ""; }
  }

  function maskIp(ip){
    if (!ip) return "";
    if (ip.includes(".")) {
      const p = ip.split(".");
      if (p.length === 4) return `${p[0]}.${p[1]}.${p[2]}.0`;
      return "";
    }
    if (ip.includes(":")) {
      const parts = ip.split(":").filter(Boolean);
      return parts.slice(0, 4).join(":") + "::";
    }
    return "";
  }

  async function collectGeo(){
    try{
      const controller = new AbortController();
      const timer = setTimeout(() => controller.abort(), 4000);
      const res = await fetch("https://ipapi.co/json/", { signal: controller.signal });
      clearTimeout(timer);
      if(!res.ok) throw new Error("geo api failed");
      const j = await res.json();
      return {
        country: j.country_name || j.country || "",
        region: j.region || "",
        city: j.city || "",
        timezone: j.timezone || getTimeZone(),
        ipMasked: maskIp(j.ip || "")
      };
    }catch(e){
      return { country:"", region:"", city:"", timezone:getTimeZone(), ipMasked:"" };
    }
  }

  async function postToGAS(payload){
    if(!GAS_WEBAPP_URL || GAS_WEBAPP_URL.includes("ã“ã“ã«")) return false;
    try{
      await fetch(GAS_WEBAPP_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      return true;
    }catch(e){
      try{
        await fetch(GAS_WEBAPP_URL, {
          method: "POST",
          mode: "no-cors",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        return true;
      }catch(e2){ return false; }
    }
  }

  /***********************
   * SNSã‚·ã‚§ã‚¢
   ***********************/
  function getShareUrl(){
    const href = location.href;
    if(href.startsWith("file:")) return "";
    return href;
  }
  function buildShareText(topTypes, rows, maxPossibleHalf){
    const url = getShareUrl();
    const topLine = (topTypes.length === 1)
      ? `ã€ã˜ã¶ã‚“è¨ºæ–­ã€‘çµæœï¼š${topTypes[0].name}ï¼ˆ${fmtHalfScore(topTypes[0].scoreHalf)} / ${fmtHalfScore(maxPossibleHalf)}ç‚¹ï¼‰`
      : `ã€ã˜ã¶ã‚“è¨ºæ–­ã€‘çµæœï¼š${topTypes.map(t=>t.name).join("ãƒ»")}ï¼ˆåŒç‚¹ãƒˆãƒƒãƒ— ${fmtHalfScore(topTypes[0].scoreHalf)} / ${fmtHalfScore(maxPossibleHalf)}ç‚¹ï¼‰`;
    const scoreLines = rows.map(r => `ãƒ»${r.name}ï¼š${fmtHalfScore(r.scoreHalf)}ç‚¹`).join("\n");
    const parts = [ topLine, "", "ã‚¹ã‚³ã‚¢ä¸€è¦§", scoreLines, "", "#ã˜ã¶ã‚“è¨ºæ–­ #è¨ºæ–­ #è‡ªå·±åˆ†æ" ];
    if(url) parts.push("", url);
    return parts.join("\n");
  }

  function setShareUI(topTypes, rows, maxPossibleHalf){
    const ta = document.getElementById("shareText");
    const copyBtn = document.getElementById("copyShareBtn");
    const nativeBtn = document.getElementById("nativeShareBtn");
    const xLink = document.getElementById("xShareLink");
    const lineLink = document.getElementById("lineShareLink");
    if(!ta) return;
    ta.value = buildShareText(topTypes, rows, maxPossibleHalf);
    if(navigator.share){
      nativeBtn.style.display = "inline-flex";
      nativeBtn.onclick = async () => {
        try{
          await navigator.share({ title:"ã˜ã¶ã‚“è¨ºæ–­", text:ta.value, url:getShareUrl()||undefined });
        }catch(e){}
      };
    }else{
      nativeBtn.style.display = "none";
    }
    copyBtn.onclick = async () => {
      try{
        await navigator.clipboard.writeText(ta.value);
      }catch(e){
        ta.focus(); ta.select(); document.execCommand("copy");
      }
      copyBtn.textContent = "ã‚³ãƒ”ãƒ¼å®Œäº†";
      setTimeout(()=> copyBtn.textContent="ã‚³ãƒ”ãƒ¼", 1200);
    };
    xLink.href = "https://twitter.com/intent/tweet?text=" + encodeURIComponent(ta.value);
    lineLink.href = "https://line.me/R/msg/text/?" + encodeURIComponent(ta.value);
  }

  /***********************
   * çŠ¶æ…‹
   ***********************/
  let QUESTION_BANK = [];
  let answers = [];
  let currentPage = 0;

  const questionArea = document.getElementById("questionArea");
  const progressFill = document.getElementById("progressFill");
  const pageInfo = document.getElementById("pageInfo");
  const answeredInfo = document.getElementById("answeredInfo");
  const prevBtn = document.getElementById("prevBtn");
  const nextBtn = document.getElementById("nextBtn");
  const submitBtn = document.getElementById("submitBtn");
  const quizForm = document.getElementById("quizForm");

  function totalPages(){ return Math.ceil(QUESTION_BANK.length / QUESTIONS_PER_PAGE); }
  function pageRange(){
    const start = currentPage * QUESTIONS_PER_PAGE;
    const end = Math.min(start + QUESTIONS_PER_PAGE, QUESTION_BANK.length);
    return { start, end };
  }

  function renderChoice(i, key, label){
    return `
      <label class="choice" for="q${i}-${key}">
        <input id="q${i}-${key}" type="radio" name="q${i}" value="${SCORE_HALF[key]}">
        <span>${label}</span>
      </label>
    `;
  }

  function updateAnsweredInfo(){
    const { start, end } = pageRange();
    let count = 0;
    for(let i=start; i<end; i++){
      if(quizForm.querySelector(`input[name="q${i}"]:checked`)) count++;
    }
    answeredInfo.textContent = `ã“ã®ãƒšãƒ¼ã‚¸ï¼š${count} / ${end-start} å›ç­”`;
  }

  function updateHeader(){
    const tp = totalPages();
    pageInfo.textContent = `${currentPage+1} / ${tp} ãƒšãƒ¼ã‚¸ï¼ˆå…¨${QUESTION_BANK.length}å•ï¼‰`;
    progressFill.style.width = ((currentPage+1)/tp * 100) + "%";
    prevBtn.style.display = "inline-block";
    prevBtn.disabled = (currentPage === 0);
    const isLast = (currentPage === tp-1);
    nextBtn.style.display = isLast ? "none" : "inline-block";
    submitBtn.style.display = isLast ? "inline-block" : "none";
    updateAnsweredInfo();
  }

  function renderPage(){
    const { start, end } = pageRange();
    questionArea.innerHTML = "";
    for(let i=start; i<end; i++){
      const q = QUESTION_BANK[i];
      const qEl = document.createElement("div");
      qEl.className = "q";
      qEl.innerHTML = `
        <div class="qhead">
          <div class="qno">Q${i+1}</div>
          <p class="qtext">${escapeHtml(q.text)}</p>
        </div>
        <div class="choices" role="group">
          ${renderChoice(i,"maru","ã€‡ ã‚ã¦ã¯ã¾ã‚‹")}
          ${renderChoice(i,"sankaku","â–³ ã©ã¡ã‚‰ã¨ã‚‚ã„ãˆãªã„")}
          ${renderChoice(i,"batsu","Ã— ã‚ã¦ã¯ã¾ã‚‰ãªã„")}
        </div>
      `;
      questionArea.appendChild(qEl);
      const val = answers[i];
      if(val !== null && val !== undefined){
        const key = val===SCORE_HALF.maru?"maru":val===SCORE_HALF.sankaku?"sankaku":"batsu";
        const r = document.getElementById(`q${i}-${key}`);
        if(r) r.checked = true;
      }
    }
    updateHeader();
    window.scrollTo({ top:0, behavior:"smooth" });
  }

  function validatePage(){
    const { start, end } = pageRange();
    for(let i=start; i<end; i++){
      if(!quizForm.querySelector(`input[name="q${i}"]:checked`)){
        alert(`Q${i+1} ãŒæœªå›ç­”ã§ã™`);
        return false;
      }
    }
    return true;
  }

  function storePageAnswers(){
    const { start, end } = pageRange();
    for(let i=start; i<end; i++){
      const sel = quizForm.querySelector(`input[name="q${i}"]:checked`);
      if(sel) answers[i] = parseInt(sel.value, 10);
    }
  }

  prevBtn.addEventListener("click", () => {
    storePageAnswers();
    if(currentPage === 0) return;
    currentPage--;
    renderPage();
  });

  nextBtn.addEventListener("click", () => {
    if(!validatePage()) return;
    storePageAnswers();
    currentPage++;
    renderPage();
  });

  quizForm.addEventListener("submit", (e) => {
    e.preventDefault();
    if(!validatePage()) return;
    storePageAnswers();
    showResult();
  });

  quizForm.addEventListener("change", (e) => {
    if(e.target?.matches('input[type="radio"]')) updateAnsweredInfo();
  });

  /***********************
   * çµæœè¡¨ç¤º
   ***********************/
  function showResult(){
    const scoresHalf = {};
    TYPES.forEach(t => scoresHalf[t.id] = 0);
    for(let i=0; i<QUESTION_BANK.length; i++){
      scoresHalf[QUESTION_BANK[i].typeId] += answers[i] ?? 0;
    }

    const maxHalf = Math.max(...Object.values(scoresHalf));
    const topTypes = TYPES.filter(t => scoresHalf[t.id] === maxHalf);
    const maxPossibleHalf = PICK_PER_TYPE * SCORE_HALF.maru;

    // ç”»é¢åˆ‡æ›¿
    document.getElementById("quizScreen").style.display = "none";
    document.getElementById("resultScreen").style.display = "block";

    // ãƒˆãƒƒãƒ—è¡¨ç¤º
    document.getElementById("topSummary").textContent =
      topTypes.length === 1
        ? `ã‚ãªãŸã®æœ€ã‚‚å¼·ã„å‚¾å‘ã¯ã€Œ${topTypes[0].name}ã€ã§ã™ï¼ˆ${fmtHalfScore(maxHalf)} / ${fmtHalfScore(maxPossibleHalf)} ç‚¹ï¼‰`
        : `åŒç‚¹ã®ãƒˆãƒƒãƒ—ãŒè¤‡æ•°ã‚ã‚Šã¾ã™ï¼š${topTypes.map(t=>t.name).join("ãƒ»")}ï¼ˆ${fmtHalfScore(maxHalf)} / ${fmtHalfScore(maxPossibleHalf)} ç‚¹ï¼‰`;

    document.getElementById("topCards").innerHTML = topTypes.map(t => `
      <div class="topCard">
        <img class="topImg" src="${t.img}" alt="${escapeHtml(t.name)}" onerror="this.style.display='none'">
        <p class="topName">${escapeHtml(t.name)}</p>
        <p class="topScore">${fmtHalfScore(scoresHalf[t.id])} / ${fmtHalfScore(maxPossibleHalf)} ç‚¹</p>
      </div>
    `).join("");

    // ã‚¹ã‚³ã‚¢è¡¨
    const rows = TYPES
      .map(t => ({ ...t, scoreHalf: scoresHalf[t.id] }))
      .sort((a,b) => b.scoreHalf - a.scoreHalf);

    document.querySelector("#scoreTable tbody").innerHTML = rows.map(r => {
      const pct = Math.round(r.scoreHalf / maxPossibleHalf * 100);
      return `
        <tr>
          <td>
            <div class="typeCell">
              <img class="typeIcon" src="${r.img}" alt="${escapeHtml(r.name)}" onerror="this.style.display='none'">
              <strong>${escapeHtml(r.name)}</strong>
            </div>
          </td>
          <td>${fmtHalfScore(r.scoreHalf)} / ${fmtHalfScore(maxPossibleHalf)} ç‚¹</td>
          <td>
            <div class="bar"><div style="width:${pct}%"></div></div>
            <div style="color:#6b6b6b;font-size:.85rem;margin-top:6px;">${pct}%</div>
          </td>
        </tr>
      `;
    }).join("");

    // ã‚·ã‚§ã‚¢UI
    const topForShare = topTypes.map(t => ({ name:t.name, scoreHalf:scoresHalf[t.id] }));
    const rowsForShare = rows.map(r => ({ name:r.name, scoreHalf:r.scoreHalf }));
    setShareUI(topForShare, rowsForShare, maxPossibleHalf);

    // GASã¸ä¿å­˜ï¼ˆãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ï¼‰
    (async () => {
      const scores = {};
      TYPES.forEach(t => { scores[t.id] = (scoresHalf[t.id]||0) / 2; });
      const shareTextEl = document.getElementById("shareText");
      const device = detectDeviceBrowserOS();
      const geo = await collectGeo();
      await postToGAS({
        topTypes: topTypes.map(t => t.name),
        scores,
        geo,
        device,
        shareText: shareTextEl ? shareTextEl.value : ""
      });
    })();

    document.getElementById("resultScreen").scrollIntoView({ behavior:"smooth" });
  }

  /***********************
   * ç”»é¢åˆ¶å¾¡
   ***********************/
  function startQuiz(){
    QUESTION_BANK = buildQuestionBank();
    answers = new Array(QUESTION_BANK.length).fill(null);
    currentPage = 0;

    document.getElementById("startScreen").style.display = "none";
    document.getElementById("quizScreen").style.display = "block";
    document.getElementById("resultScreen").style.display = "none";
    renderPage();
    window.scrollTo({ top:0, behavior:"smooth" });
  }

  document.getElementById("retryBtn").addEventListener("click", () => {
    document.getElementById("resultScreen").style.display = "none";
    document.getElementById("startScreen").style.display = "block";
    window.scrollTo({ top:0, behavior:"smooth" });
  });
</script>
</body>
</html>
